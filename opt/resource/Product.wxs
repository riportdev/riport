<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

	<!-- Full version number to display -->
	<?define VersionNumber="!(bind.FileVersion.rportClientExe)" ?>

	<!-- Upgrade code HAS to be the same for all updates. Once you've chosen it don't change it. -->
	<?define UpgradeCode="181410DA-06A6-413A-A1C7-261B894D4999" ?>	<!-- YOUR-GUID-HERE -->

	<!-- The URL for add/remove programs -->
	<?define InfoURL="https://rport.io/" ?>

	<?define Win64 = "yes" ?>
	<?define rportClientExeSourcePath = "rport.exe" ?>

	<!-- The upgrade code must never change as long as the product lives! -->
	<!-- Product IDs must be autogenerated (*) or else major upgrades will not work -->
	<Product Id="*" Name="!(loc.ApplicationName)" Language="!(loc.Language)" Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerFullName)" UpgradeCode="$(var.UpgradeCode)">

		<!-- Package IDs are valid for a single package version only - they are autogenerated by WiX -->
		<!-- Let's require Windows Installer 4.0 (included in Vista) -->
		<!-- And ALWAYS install per machine!!! -->
		<Package Id="*" Platform="x64" InstallerVersion="400" Compressed="yes" InstallScope="perMachine" Description="!(loc.ProductDescription)" Comments="!(loc.Comments) $(var.VersionNumber)" />

		<!-- License agreement text: dummy. Real text is set in WXS file -->
		<WixVariable Id="WixUILicenseRtf" Value="dummy" />

		<!-- UI customization -->
		<WixVariable Id="WixUIBannerBmp" Value="opt\resource\images\BannerTop.bmp" />
		<WixVariable Id="WixUIDialogBmp" Value="opt\resource\images\Dialog.bmp" />

		<!-- Define icons (ID should not be longer than 18 chars and must end with ".exe") -->
		<Icon Id="Icon.exe" SourceFile="opt\resource\images\app.ico" />

		<!-- Set properties for add/remove programs -->
		<Property Id="ARPPRODUCTICON" Value="Icon.exe" />
		<Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
		<Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
		<!-- Remove repair -->
		<Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
		<!-- Remove modify -->

		<!-- Upgrade logic -->
		<!-- AllowSameVersionUpgrades -> Always upgrade, never allow two versions to be installed next to each other -->
		<!-- AllowSameVersionUpgrades causes ICE61 which must be ignored -->
		<MajorUpgrade DowngradeErrorMessage="!(loc.NewerInstalled)" AllowSameVersionUpgrades="yes" />

		<!-- This is the main installer sequence run when the product is actually installed -->
		<InstallExecuteSequence>
			<!-- Determine the install location after the install path has been validated by the installer -->
			<Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
		</InstallExecuteSequence>
		<!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
		<CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />

		<Condition Message="!(loc.OS2Old)">
			<![CDATA[Installed OR (VersionNT >= 600)]]>
		</Condition>

		<!-- Determine the directory of a previous installation (if one exists). If not INSTALLDIR stays empty -->
		<Property Id="INSTALLDIR">
			<RegistrySearch Id="DetermineInstallLocation" Type="raw" Root="HKLM" Key="Software\!(loc.ManufacturerName)\InstalledProducts\!(loc.ApplicationName)" Name="InstallLocation" />
		</Property>

		<Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFiles64Folder">
				<!-- All folders from here on are relative to their parent. -->
				<!-- INSTALLDIR is a property name. We need it later for the UI (to be able to change the install dir. -->
				<Directory Id="INSTALLDIR" Name="!(loc.ApplicationName)">
					<!-- Installation directory as a component so it can be emptied during uninstall (by default files added by someone other than Windows Installer are not removed) -->
					<Component Win64="yes" Id="INSTALLDIR_comp" Guid="$(var.UpgradeCode)">
						<CreateFolder />
					</Component>

					<!-- Main program file -->
					<Component Win64="yes" Id="rportClient.exe_comp" Guid="*" >
						<File Source="$(var.rportClientExeSourcePath)" Id="rportClientExe" Name="rport.exe" DiskId='1' Vital="yes" KeyPath="yes"/>
						<ServiceInstall Id="ServiceInstaller"
											Type="ownProcess"
											Name="rport"
											DisplayName="Rport Client"
											Start="auto"
											Description="Create reverse Tunnels with ease."
											Account="[SERVICEACCOUNT]"
											Password="[SERVICEPASSWORD]"
                                            Interactive="no"
                                            ErrorControl="ignore"
											Arguments="-c &quot;[INSTALLDIR]rport.conf&quot;"  
											>

								<ServiceConfig DelayedAutoStart="yes" OnInstall="yes" OnReinstall ="yes" />
								<util:ServiceConfig 
										FirstFailureActionType='restart'
										SecondFailureActionType='restart'
										ThirdFailureActionType='restart'            
										RestartServiceDelayInSeconds='30'
										/>
						</ServiceInstall>
						<ServiceControl Id="ServiceInstaller" 
											Name="rport"
											Remove="uninstall" 
											Stop="uninstall" 
											Wait="yes" />

					</Component>
	
					<!-- Configuration file -->
					<Component Win64="yes" Id="rportClient.conf_comp" Guid="*">
						<File Source="rport.example.conf" Id="RPortConf" KeyPath="yes" />
					</Component>
				</Directory>
			</Directory>
		</Directory>

		<!-- Features define which parts of the application can be installed in a custom installation -->
		<Feature Id="Complete" Title="!(loc.ApplicationName)" Description="!(loc.FeatureCompleteDescription)" Display="expand" Level="1" ConfigurableDirectory="INSTALLDIR">
			<!-- A feature block for the main (GUI) program and all its dependencies -->
			<Feature Id="MainProgram" Title="!(loc.FeatureMainProgramTitle)" Description="!(loc.FeatureMainProgramDescription)" Level="1">
				<ComponentRef Id="INSTALLDIR_comp" />
				<ComponentRef Id="rportClient.exe_comp" />
				<ComponentRef Id="rportClient.conf_comp" />
			</Feature>
		</Feature>
		<UI>
			<UIRef Id="WixUI_HK" />
		</UI>
		<Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
	</Product>
</Wix>